<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steam Analytics Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #111836;
        --text: #e8ecff;
        --muted: #b9c1ff;
        --border: rgba(255, 255, 255, 0.12);
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 60px;
      }
      header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }
      h1 {
        font-size: 22px;
        margin: 0;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 14px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 520px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
      }
      .label {
        color: var(--muted);
        font-size: 12px;
        margin-bottom: 6px;
      }
      .value {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .small {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }
      section {
        margin-top: 18px;
      }
      h2 {
        font-size: 16px;
        margin: 18px 0 10px;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      select {
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
      }
      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
      }
      th {
        color: var(--muted);
        font-weight: 600;
        text-align: left;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .error {
        margin-top: 14px;
        padding: 10px 12px;
        border: 1px solid rgba(255, 120, 120, 0.35);
        background: rgba(255, 120, 120, 0.1);
        border-radius: 12px;
        color: #ffdada;
        display: none;
      }

      /* simple chart box */
      .chart {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
      }
      .chart-meta {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
        color: var(--muted);
        font-size: 12px;
      }
      .chart svg {
        width: 100%;
        height: 260px;
        display: block;
      }
      .axis-label {
        fill: rgba(255, 255, 255, 0.6);
        font-size: 11px;
      }
      .tick {
        stroke: rgba(255, 255, 255, 0.12);
      }
      .line {
        fill: none;
        stroke: rgba(230, 235, 255, 0.95);
        stroke-width: 2;
      }
      .dot {
        fill: rgba(230, 235, 255, 0.95);
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div>
          <h1>Steam Analytics Dashboard</h1>
          <div class="sub">
            Statistics computed from stored achievement events (timezone
            handling where relevant).
          </div>
        </div>
      </header>

      <div id="error" class="error"></div>

      <section>
        <div class="grid">
          <div class="card">
            <div class="label">Total games with achievements</div>
            <div id="gamesWithAchievements" class="value">—</div>
            <div class="small" id="totalOwnedGames">Total games owned: —</div>
          </div>

          <div class="card">
            <div class="label">Total achievements</div>
            <div id="totalAchievements" class="value">—</div>
            <div class="small" id="lastAchievement">Last achievement: —</div>
          </div>

          <div class="card">
            <div class="label">Average achievements per game</div>
            <div id="avgAchievements" class="value">—</div>
            <div class="small">
              Average is computed over games where you have at least one
              achievement.
            </div>
          </div>

          <div class="card">
            <div class="label">Best achievement streak</div>
            <div id="bestStreakDays" class="value">—</div>
            <div class="small" id="bestStreakDates">—</div>
          </div>
        </div>
      </section>

      <section>
        <h2>Achievements by weekday (Europe/Oslo time)</h2>
        <table>
          <thead>
            <tr>
              <th>Weekday</th>
              <th>Achievements</th>
            </tr>
          </thead>
          <tbody id="weekdayRows"></tbody>
        </table>
      </section>

      <section>
        <div class="row">
          <h2 style="margin: 18px 0 10px">Cumulative achievements over time</h2>
          <div>
            <label class="sub" for="monthsSelect">Months range:</label>
            <select id="monthsSelect">
              <option value="all">All</option>
              <option value="24">24</option>
              <option value="60">60</option>
              <option value="120" selected>120</option>
              <option value="240">240</option>
            </select>
          </div>
        </div>

        <div class="chart">
          <div class="chart-meta">
            <div id="chartRange">—</div>
            <div class="sub">
              x-axis: month, y-axis: cumulative achievements
            </div>
          </div>

          <svg id="chartSvg" viewBox="0 0 900 260" preserveAspectRatio="none">
            <g id="grid"></g>
            <path id="linePath" class="line" d="" />
            <g id="dots"></g>

            <text class="axis-label" x="10" y="10">Cumulative</text>
            <text class="axis-label" x="10" y="250">Months →</text>
          </svg>
        </div>
      </section>
    </div>

    <script>
      function showError(msg) {
        const el = document.getElementById("error");
        el.textContent = msg;
        el.style.display = "block";
      }

      function fmtIso(iso) {
        if (!iso) return "—";
        try {
          return new Date(iso).toISOString().slice(0, 10);
        } catch {
          return iso;
        }
      }

      async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return res.json();
      }

      async function loadSummary() {
        const data = await fetchJson("/dashboard/summary");
        const s = data.summary;

        document.getElementById("gamesWithAchievements").textContent =
          s.uniqueGamesWithUnlocks ?? "—";

        document.getElementById("totalAchievements").textContent =
          s.totalUnlocks ?? "—";

        document.getElementById("avgAchievements").textContent =
          s.averageAchievementsPerGame ?? "—";

        document.getElementById("lastAchievement").textContent =
          "Last achievement: " + fmtIso(s.lastUnlockedAt);

        const streak = s.bestStreak;
        if (streak && streak.days > 0) {
          document.getElementById("bestStreakDays").textContent =
            streak.days + " days";
          document.getElementById("bestStreakDates").textContent =
            `From ${streak.startDate} to ${streak.endDate} (${streak.dates.length} dates)`;
        } else {
          document.getElementById("bestStreakDays").textContent = "0 days";
          document.getElementById("bestStreakDates").textContent =
            "No streak data";
        }
      }

      async function loadTotalOwnedGames() {
        // Fetch total owned games from Steam.
        const data = await fetchJson("/steam/owned-games");
        document.getElementById("totalOwnedGames").textContent =
          "Total games owned: " + (data.totalOwned ?? "—");
      }
      async function loadWeekday() {
        const data = await fetchJson("/dashboard/achievements-by-weekday");
        const rows = data.rows ?? [];

        const tbody = document.getElementById("weekdayRows");
        tbody.innerHTML = "";

        for (const r of rows) {
          const tr = document.createElement("tr");
          const td1 = document.createElement("td");
          const td2 = document.createElement("td");
          td1.textContent = r.weekday;
          td2.textContent = String(r.achievements);
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        }
      }

      function drawGrid(svgW, yMax, padding) {
        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        const lines = 5;
        const top = padding.top;
        const H = 260 - padding.top - padding.bottom;

        for (let i = 0; i <= lines; i++) {
          const t = i / lines; // 0..1
          const y = top + H * t;
          const val = Math.round(yMax - yMax * t);

          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", "0");
          line.setAttribute("y1", String(y));
          line.setAttribute("x2", String(svgW));
          line.setAttribute("y2", String(y));
          line.setAttribute("class", "tick");
          grid.appendChild(line);

          const text = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          text.setAttribute("x", "6");
          text.setAttribute("y", String(y - 4));
          text.setAttribute("class", "axis-label");
          text.textContent = String(val);
          grid.appendChild(text);
        }
      }

      function drawCumulativeChart(points) {
        const svgW = 900;
        const svgH = 260;

        const linePath = document.getElementById("linePath");
        const dots = document.getElementById("dots");
        dots.innerHTML = "";

        if (!points || points.length === 0) {
          document.getElementById("grid").innerHTML = "";
          linePath.setAttribute("d", "");
          return;
        }

        const padding = { left: 30, right: 20, top: 30, bottom: 30 };
        const W = svgW - padding.left - padding.right;
        const H = svgH - padding.top - padding.bottom;

        const ys = points.map((p) => p.cumulativeAchievements);
        const yMax = Math.max(...ys, 1);

        // grid + y-labels
        drawGrid(svgW, yMax, padding);

        const xScale = (i) =>
          padding.left +
          (points.length === 1 ? W / 2 : (i * W) / (points.length - 1));

        const yScale = (v) => padding.top + (H - (v / yMax) * H);

        // path
        let d = "";
        for (let i = 0; i < points.length; i++) {
          const x = xScale(i);
          const y = yScale(points[i].cumulativeAchievements);
          d += (i === 0 ? "M" : " L") + x.toFixed(2) + " " + y.toFixed(2);
        }
        linePath.setAttribute("d", d);

        // dots (limit)
        const maxDots = 40;
        const step = Math.max(1, Math.floor(points.length / maxDots));
        for (let i = 0; i < points.length; i += step) {
          const p = points[i];
          const cx = xScale(i);
          const cy = yScale(p.cumulativeAchievements);

          const c = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle",
          );
          c.setAttribute("cx", String(cx));
          c.setAttribute("cy", String(cy));
          c.setAttribute("r", "2.5");
          c.setAttribute("class", "dot");
          dots.appendChild(c);
        }
      }

      async function loadCumulative(monthsValue) {
        const monthsParam = monthsValue === "all" ? 10000 : Number(monthsValue);

        const data = await fetchJson(
          `/dashboard/cumulative-achievements-by-month?months=${encodeURIComponent(
            monthsParam,
          )}`,
        );

        const rows = data.rows ?? [];

        if (rows.length > 0) {
          document.getElementById("chartRange").textContent =
            `${rows[0].month} → ${
              rows[rows.length - 1].month
            } (${rows.length} points)`;
        } else {
          document.getElementById("chartRange").textContent = "No data";
        }

        drawCumulativeChart(rows);
      }

      async function init() {
        try {
          await loadSummary();
          await loadTotalOwnedGames();
          await loadWeekday();

          const sel = document.getElementById("monthsSelect");
          await loadCumulative(sel.value);

          sel.addEventListener("change", async () => {
            try {
              await loadCumulative(sel.value);
            } catch (err) {
              showError("Failed to load cumulative chart: " + err.message);
            }
          });
        } catch (err) {
          showError("Dashboard failed to load: " + err.message);
        }
      }

      init();
    </script>
  </body>
</html>
